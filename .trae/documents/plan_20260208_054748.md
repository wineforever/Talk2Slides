# è§£å†³è§†é¢‘ç”ŸæˆæˆåŠŸä½†æ— è¾“å‡ºæ–‡ä»¶é—®é¢˜

## é—®é¢˜è¯Šæ–­ç»“æœ

ç»è¿‡æ·±å…¥ä»£ç åˆ†æï¼Œå‘ç°ç”¨æˆ·é‡åˆ°çš„"è§†é¢‘ç”ŸæˆæˆåŠŸä½†æ— è¾“å‡ºæ–‡ä»¶"é—®é¢˜çš„æ ¹æœ¬åŸå› åœ¨äºï¼š

### ğŸ” å…³é”®å‘ç°

1. **æ—¶é—´è½´æ•°æ®æ— æ•ˆé—®é¢˜**ï¼š
   - å¤‡ç”¨ç­–ç•¥ç”Ÿæˆçš„æ—¶é—´è½´å¯èƒ½åŒ…å«`end <= start`çš„æ—¶é—´ç‰‡æ®µ
   - å¯¼è‡´`duration`ä¸º0æˆ–è´Ÿæ•°ï¼ŒFFmpegæ— æ³•å¤„ç†
   - `_create_concat_file`æ–¹æ³•æœªéªŒè¯æ—¶é—´æœ‰æ•ˆæ€§

2. **è°ƒè¯•ä¿¡æ¯ä¸å®Œæ•´**ï¼š
   - ç”¨æˆ·çœ‹åˆ°"DPç®—æ³•å¤±è´¥"å’Œ"å°è¯•å¤‡ç”¨ç­–ç•¥"çš„æ—¥å¿—
   - ä½†æœªçœ‹åˆ°"å¤‡ç”¨ç­–ç•¥æˆåŠŸ"æˆ–"å¤‡ç”¨ç­–ç•¥ä¹Ÿå¤±è´¥"çš„åç»­æ—¥å¿—
   - éš¾ä»¥åˆ¤æ–­å®é™…å¤±è´¥ç‚¹

3. **é”™è¯¯å¤„ç†å¯èƒ½åæ‰å¼‚å¸¸**ï¼š
   - è™½ç„¶ä»£ç æœ‰å¼‚å¸¸å¤„ç†ï¼Œä½†åœ¨æŸäº›è¾¹ç•Œæƒ…å†µä¸‹å¼‚å¸¸å¯èƒ½è¢«é”™è¯¯å¤„ç†
   - æ–‡ä»¶éªŒè¯é€»è¾‘å¯èƒ½é€šè¿‡ä½†æ–‡ä»¶å®é™…ä¸Šæœªæ­£ç¡®ç”Ÿæˆ

4. **å¤‡ç”¨ç­–ç•¥è¾¹ç•Œæƒ…å†µ**ï¼š
   - å‡åŒ€åˆ†å¸ƒç­–ç•¥åœ¨å­—å¹•æ—¶é•¿å¾ˆçŸ­æˆ–å¹»ç¯ç‰‡å¾ˆå¤šæ—¶å¯èƒ½ç”Ÿæˆæ— æ•ˆæ—¶é—´è½´

## è§£å†³æ–¹æ¡ˆ

### ç¬¬ä¸€é˜¶æ®µï¼šå¢å¼ºæ—¶é—´è½´éªŒè¯å’Œè°ƒè¯•ä¿¡æ¯ï¼ˆç«‹å³ä¿®å¤ï¼‰

#### 1. ä¿®å¤`video_service.py`ä¸­çš„`_create_concat_file`æ–¹æ³•
- **æ·»åŠ æ—¶é—´è½´æœ‰æ•ˆæ€§éªŒè¯**ï¼š
  ```python
  # éªŒè¯æ¯ä¸ªæ—¶é—´ç‰‡æ®µ
  if duration <= 0:
      raise ValueError(f"æ—¶é—´ç‰‡æ®µ{i}æ—¶é•¿æ— æ•ˆ: start={segment['start']}, end={segment['end']}, duration={duration}")
  if end <= start:
      raise ValueError(f"æ—¶é—´ç‰‡æ®µ{i}ç»“æŸæ—¶é—´ä¸å¤§äºå¼€å§‹æ—¶é—´: start={start}, end={end}")
  ```

- **å¢å¼ºè°ƒè¯•æ—¥å¿—**ï¼š
  ```python
  logger.info(f"æ—¶é—´ç‰‡æ®µç»Ÿè®¡: æ€»æ—¶é•¿={total_duration:.2f}ç§’, å¹³å‡æ—¶é•¿={avg_duration:.2f}ç§’")
  logger.info(f"æ—¶é—´èŒƒå›´éªŒè¯: æ‰€æœ‰ç‰‡æ®µend>start={all_valid}")
  ```

#### 2. å¢å¼º`alignment_service.py`å¤‡ç”¨ç­–ç•¥
- **æ·»åŠ æ—¶é—´è½´æœ‰æ•ˆæ€§æ£€æŸ¥**ï¼š
  ```python
  # åœ¨å¤‡ç”¨ç­–ç•¥è¿”å›å‰éªŒè¯æ—¶é—´è½´
  validated_timeline = self._validate_timeline(timeline)
  if not validated_timeline:
      logger.error("å¤‡ç”¨ç­–ç•¥ç”Ÿæˆçš„æ—¶é—´è½´æ— æ•ˆ")
      return []
  ```

- **ä¿®å¤å‡åŒ€åˆ†å¸ƒç®—æ³•è¾¹ç•Œæƒ…å†µ**ï¼š
  ```python
  # ç¡®ä¿slide_durationè‡³å°‘ä¸º0.1ç§’
  slide_duration = max(0.1, slide_duration)
  # éªŒè¯ç”Ÿæˆçš„æ—¶é—´ç‰‡æ®µ
  for segment in timeline:
      if segment["end"] <= segment["start"]:
          # ä¿®å¤æ— æ•ˆç‰‡æ®µ
          segment["end"] = segment["start"] + min_display_duration
  ```

#### 3. å¢å¼º`video_service.py`ä¸­çš„æ–‡ä»¶éªŒè¯
- **éªŒè¯æ–‡ä»¶å¤§å°è€Œä¸ä»…ä»…æ˜¯å­˜åœ¨**ï¼š
  ```python
  # æ£€æŸ¥æ–‡ä»¶å¤§å°è‡³å°‘ä¸º1KB
  if Path(temp_video).stat().st_size < 1024:
      raise Exception(f"è§†é¢‘æ–‡ä»¶å¤ªå°å¯èƒ½æ— æ•ˆ: {temp_video}, å¤§å°={video_size}å­—èŠ‚")
  ```

- **æ·»åŠ æ›´è¯¦ç»†çš„è·¯å¾„æ—¥å¿—**ï¼š
  ```python
  logger.info(f"è¾“å‡ºæ–‡ä»¶å®Œæ•´è·¯å¾„: {Path(output_path).resolve()}")
  logger.info(f"è¾“å‡ºç›®å½•æƒé™: å¯å†™={os.access(output_dir, os.W_OK)}")
  ```

### ç¬¬äºŒé˜¶æ®µï¼šä¿®å¤é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ›´æ–°

#### 1. ä¿®å¤`endpoints.py`ä¸­çš„å¼‚å¸¸ä¼ æ’­
- **ç¡®ä¿æ‰€æœ‰å¼‚å¸¸éƒ½è¢«æ­£ç¡®ä¼ æ’­**ï¼š
  ```python
  try:
      video_service.create_video_from_timeline(...)
  except Exception as e:
      # è®°å½•åŸå§‹å¼‚å¸¸
      logger.error(f"è§†é¢‘åˆæˆå¼‚å¸¸è¯¦æƒ…: {str(e)}", exc_info=True)
      # é‡æ–°æŠ›å‡ºå¢å¼ºçš„å¼‚å¸¸
      raise Exception(f"è§†é¢‘åˆæˆé˜¶æ®µå¤±è´¥: {str(e)}") from e
  ```

- **æ·»åŠ é˜¶æ®µæ ‡è®°**ï¼š
  ```python
  # åœ¨å…³é”®æ­¥éª¤æ·»åŠ é˜¶æ®µæ ‡è®°
  processing_stage = "unknown"
  try:
      processing_stage = "ppt_parsing"
      # PPTè§£æ...
      
      processing_stage = "srt_parsing" 
      # SRTè§£æ...
      
      processing_stage = "alignment"
      # è¯­ä¹‰å¯¹é½...
      
      processing_stage = "video_synthesis"
      # è§†é¢‘åˆæˆ...
  except Exception as e:
      logger.error(f"å¤±è´¥é˜¶æ®µ: {processing_stage}, é”™è¯¯: {str(e)}")
      raise
  ```

#### 2. å¢å¼ºä»»åŠ¡çŠ¶æ€æ›´æ–°
- **æ·»åŠ æ›´è¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯**ï¼š
  ```python
  task_manager.update_task(
      task_id,
      state=TaskStatus.PROCESSING,
      progress=70,
      message=f"è§†é¢‘åˆæˆä¸­... (é˜¶æ®µ: {processing_stage})",
      details={
          "current_stage": processing_stage,
          "timeline_count": len(timeline) if timeline else 0,
          "output_path": str(output_video_path)
      }
  )
  ```

### ç¬¬ä¸‰é˜¶æ®µï¼šæ·»åŠ è¯Šæ–­å·¥å…·å’Œæµ‹è¯•

#### 1. åˆ›å»ºæ—¶é—´è½´è¯Šæ–­å·¥å…·
```python
def diagnose_timeline(timeline: List[Dict[str, Any]]) -> Dict[str, Any]:
    """è¯Šæ–­æ—¶é—´è½´æœ‰æ•ˆæ€§"""
    stats = {
        "total_segments": len(timeline),
        "valid_segments": 0,
        "invalid_segments": [],
        "total_duration": 0.0,
        "min_duration": float('inf'),
        "max_duration": 0.0
    }
    
    for i, segment in enumerate(timeline):
        duration = segment["end"] - segment["start"]
        is_valid = duration > 0 and segment["end"] > segment["start"]
        
        if is_valid:
            stats["valid_segments"] += 1
            stats["total_duration"] += duration
            stats["min_duration"] = min(stats["min_duration"], duration)
            stats["max_duration"] = max(stats["max_duration"], duration)
        else:
            stats["invalid_segments"].append({
                "index": i,
                "start": segment["start"],
                "end": segment["end"],
                "duration": duration,
                "slide_index": segment.get("slide_index", -1)
            })
    
    return stats
```

#### 2. æ·»åŠ æµ‹è¯•ç”¨ä¾‹éªŒè¯è¾¹ç•Œæƒ…å†µ
```python
def test_fallback_strategy_edge_cases():
    """æµ‹è¯•å¤‡ç”¨ç­–ç•¥è¾¹ç•Œæƒ…å†µ"""
    test_cases = [
        {"slides": 10, "subtitles_duration": 5.0, "expected": "åº”è¯¥è°ƒæ•´æ—¶é•¿"},
        {"slides": 1, "subtitles_duration": 60.0, "expected": "å•å¼ å¹»ç¯ç‰‡é•¿æ—¶é—´"},
        {"slides": 5, "subtitles_duration": 0.5, "expected": "è¶…çŸ­æ—¶é•¿å¤„ç†"},
    ]
    
    for case in test_cases:
        # æ¨¡æ‹Ÿæµ‹è¯•æ•°æ®
        slides = [{"index": i, "full_text": f"Slide {i}"} for i in range(case["slides"])]
        subtitles = [
            {"start": 0.0, "end": case["subtitles_duration"], "text": "Test"}
        ]
        
        timeline = alignment_service._create_uniform_timeline_fallback(
            slides=slides,
            subtitles=subtitles,
            min_display_duration=1.0
        )
        
        # éªŒè¯ç»“æœ
        assert timeline, f"æµ‹è¯•å¤±è´¥: {case['expected']}"
        for segment in timeline:
            assert segment["end"] > segment["start"], "ç»“æŸæ—¶é—´å¿…é¡»å¤§äºå¼€å§‹æ—¶é—´"
            assert segment["duration"] > 0, "æ—¶é•¿å¿…é¡»å¤§äº0"
```

### ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

#### 1. æä¾›æ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
```python
def get_user_friendly_error(exception: Exception) -> str:
    """å°†æŠ€æœ¯å¼‚å¸¸è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½ä¿¡æ¯"""
    error_msg = str(exception)
    
    if "duration <= 0" in error_msg or "end <= start" in error_msg:
        return "æ—¶é—´è½´æ•°æ®æ— æ•ˆï¼šå¹»ç¯ç‰‡å±•ç¤ºæ—¶é•¿ä¸º0æˆ–è´Ÿæ•°ã€‚\nå¯èƒ½åŸå› ï¼šå­—å¹•æ–‡ä»¶æ—¶é—´æˆ³é”™è¯¯æˆ–å¤‡ç”¨ç­–ç•¥è®¡ç®—é—®é¢˜ã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥SRTæ–‡ä»¶æ—¶é—´æˆ³æ ¼å¼ã€‚"
    
    elif "Invalid data found when processing input" in error_msg:
        return "è§†é¢‘åˆæˆå¤±è´¥ï¼šFFmpegæ— æ³•å¤„ç†è¾“å…¥æ–‡ä»¶ã€‚\nå¯èƒ½åŸå› ï¼šå›¾ç‰‡æ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ”¯æŒã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥PPTæ–‡ä»¶å†…å®¹æˆ–å°è¯•é‡æ–°ä¸Šä¼ ã€‚"
    
    elif "No such file or directory" in error_msg:
        return "æ–‡ä»¶è·¯å¾„é”™è¯¯ï¼šç³»ç»Ÿæ‰¾ä¸åˆ°æŒ‡å®šæ–‡ä»¶ã€‚\nå¯èƒ½åŸå› ï¼šä¸´æ—¶æ–‡ä»¶è¢«æ¸…ç†æˆ–æƒé™é—®é¢˜ã€‚\nè§£å†³æ–¹æ¡ˆï¼šè¯·é‡æ–°å°è¯•ç”Ÿæˆè§†é¢‘ã€‚"
    
    else:
        return f"å¤„ç†å¤±è´¥ï¼š{error_msg}\nè¯·è”ç³»æŠ€æœ¯æ”¯æŒå¹¶æä¾›è¯¦ç»†æ—¥å¿—ã€‚"
```

#### 2. æ·»åŠ è¿›åº¦åé¦ˆå’Œé¢„ä¼°æ—¶é—´
```python
def estimate_processing_time(slides_count: int, subtitles_count: int) -> str:
    """é¢„ä¼°å¤„ç†æ—¶é—´"""
    base_time = 10  # åŸºç¡€å¤„ç†æ—¶é—´ï¼ˆç§’ï¼‰
    slide_time = slides_count * 2  # æ¯å¼ å¹»ç¯ç‰‡å¤„ç†æ—¶é—´
    subtitle_time = subtitles_count * 0.5  # æ¯ä¸ªå­—å¹•å¤„ç†æ—¶é—´
    
    total_seconds = base_time + slide_time + subtitle_time
    if total_seconds < 60:
        return f"çº¦{int(total_seconds)}ç§’"
    else:
        return f"çº¦{int(total_seconds/60)}åˆ†é’Ÿ"
```

## å®æ–½ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰
1. **ä¿®å¤æ—¶é—´è½´éªŒè¯** - é˜²æ­¢æ— æ•ˆdurationå¯¼è‡´FFmpegå¤±è´¥
2. **å¢å¼ºè°ƒè¯•æ—¥å¿—** - æ˜ç¡®æ˜¾ç¤ºå¤‡ç”¨ç­–ç•¥ç»“æœå’Œå¤±è´¥ç‚¹
3. **ä¿®å¤æ–‡ä»¶éªŒè¯** - éªŒè¯æ–‡ä»¶å¤§å°è€Œä¸ä»…ä»…æ˜¯å­˜åœ¨

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆä»Šå¤©å†…å®Œæˆï¼‰
1. **ä¿®å¤å¼‚å¸¸ä¼ æ’­** - ç¡®ä¿æ‰€æœ‰é”™è¯¯éƒ½è¢«æ­£ç¡®æŠ¥å‘Š
2. **æ·»åŠ é˜¶æ®µæ ‡è®°** - æ˜ç¡®å¤±è´¥é˜¶æ®µ
3. **ä¼˜åŒ–å¤‡ç”¨ç­–ç•¥** - å¤„ç†è¾¹ç•Œæƒ…å†µ

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆåç»­æ”¹è¿›ï¼‰
1. **è¯Šæ–­å·¥å…·** - å¸®åŠ©è°ƒè¯•å¤æ‚é—®é¢˜
2. **ç”¨æˆ·å‹å¥½é”™è¯¯** - æ”¹å–„ç”¨æˆ·ä½“éªŒ
3. **è¿›åº¦é¢„ä¼°** - æä¾›æ›´å¥½çš„åé¦ˆ

## é¢„æœŸç»“æœ

å®Œæˆä¿®å¤åï¼Œç³»ç»Ÿå°†èƒ½å¤Ÿï¼š

### âœ… æˆåŠŸåœºæ™¯
1. **æœ‰æ•ˆæ—¶é—´è½´** â†’ æ­£å¸¸ç”Ÿæˆè§†é¢‘æ–‡ä»¶
2. **æ— æ•ˆæ—¶é—´è½´** â†’ æ˜ç¡®é”™è¯¯ä¿¡æ¯ï¼ŒæŒ‡å‡ºå…·ä½“é—®é¢˜
3. **è¾¹ç•Œæƒ…å†µ** â†’ å¤‡ç”¨ç­–ç•¥è‡ªåŠ¨è°ƒæ•´ï¼Œç”Ÿæˆæœ‰æ•ˆæ—¶é—´è½´

### ğŸ› é”™è¯¯åœºæ™¯
1. **durationä¸º0/è´Ÿæ•°** â†’ æ—©æœŸæ£€æµ‹å¹¶æŠ¥å‘Šï¼Œé¿å…FFmpegå¤±è´¥
2. **æ–‡ä»¶ç”Ÿæˆå¤±è´¥** â†’ è¯¦ç»†é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®
3. **è·¯å¾„/æƒé™é—®é¢˜** â†’ æ˜ç¡®è¯Šæ–­å’Œä¿®å¤æŒ‡å¯¼

### ğŸ“Š å¯è§‚æµ‹æ€§
1. **å®Œæ•´å¤„ç†æ—¥å¿—** â†’ æ¯ä¸ªé˜¶æ®µçš„çŠ¶æ€å’Œç»“æœ
2. **æ—¶é—´è½´ç»Ÿè®¡** â†’ ç‰‡æ®µæ•°é‡ã€æ€»æ—¶é•¿ã€æœ‰æ•ˆæ€§
3. **æ–‡ä»¶éªŒè¯** â†’ è·¯å¾„ã€å¤§å°ã€æƒé™ä¿¡æ¯

---

ç¡®è®¤æ­¤è®¡åˆ’åï¼Œæˆ‘å°†å¼€å§‹å®æ–½ä¿®å¤ã€‚