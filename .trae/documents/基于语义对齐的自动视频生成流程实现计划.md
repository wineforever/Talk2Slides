# 基于语义对齐的自动视频生成流程实现计划

## 项目概述
实现一个基于语义对齐的自动视频生成Web应用，用户上传PPTX文件、MP3音频文件和SRT字幕文件，系统通过语义对齐算法将字幕时间段与PPT页面匹配，生成按语音内容自动切换页面的MP4视频。

## 技术栈选择
### 后端
- **Python 3.9+**：主编程语言
- **FastAPI**：Web框架，提供REST API和异步支持
- **python-pptx**：PPTX文件解析，提取页面文本
- **pysrt**：SRT字幕文件解析
- **sentence-transformers**：文本向量化模型（如all-MiniLM-L6-v2）
- **numpy/scipy**：向量计算和余弦相似度
- **pdf2image**：将PPTX转换后的PDF导出为图片
- **pptx2pdf**：PPTX转PDF（依赖LibreOffice或unoconv）
- **ffmpeg-python**：视频合成（或直接调用ffmpeg命令行）
- **SQLAlchemy + SQLite**：任务状态存储（可选）
- **celery**：异步任务处理（可选，使用FastAPI BackgroundTasks简化）

### 前端
- **Vue 3**：前端框架
- **Vite**：构建工具
- **Element Plus**：UI组件库
- **Axios**：HTTP客户端
- **Vue Router**：页面路由（单页面应用）
- **Pinia**：状态管理

### 开发环境
- **Windows/Linux/macOS**：支持跨平台
- **FFmpeg**：必须预先安装
- **LibreOffice**：用于PPTX转PDF（如使用pptx2pdf）

## 系统架构
### 模块划分
1. **文件上传模块**：接收并验证PPTX、MP3、SRT文件
2. **PPT解析模块**：提取每页PPT的标题和正文文本
3. **字幕解析模块**：解析SRT文件，获取时间戳和文本片段
4. **语义对齐模块**：
   - 加载sentence-transformers模型
   - 计算PPT页面和字幕片段的embedding
   - 余弦相似度匹配
   - 应用约束（页面单调不减、相似度阈值、最小展示时长）生成时间轴映射
5. **图片导出模块**：
   - PPTX转PDF（使用pptx2pdf）
   - PDF转图片序列（使用pdf2image）
6. **视频合成模块**：
   - 根据时间轴映射将图片序列与音频合成MP4视频
7. **任务管理模块**：
   - 任务状态跟踪（pending, processing, completed, failed）
   - 进度更新
8. **WebUI模块**：
   - 文件上传界面
   - 参数配置（相似度阈值、最小展示时长）
   - 实时进度显示
   - 结果预览和下载

## 实施步骤
### 第一阶段：项目初始化与环境配置（1天）
1. 创建项目目录结构
2. 初始化Python虚拟环境，创建requirements.txt
3. 初始化前端项目（Vue 3 + Vite）
4. 配置开发环境（安装FFmpeg、LibreOffice）

### 第二阶段：后端核心功能开发（3天）
1. 实现文件上传API端点
2. 开发PPT解析器（提取页面文本）
3. 开发字幕解析器（解析SRT时间戳和文本）
4. 实现语义对齐算法：
   - 加载sentence-transformers模型
   - 计算embedding和相似度矩阵
   - 实现约束优化算法生成时间轴映射
5. 开发图片导出模块：
   - 集成pptx2pdf进行PPTX转PDF
   - 使用pdf2image将PDF转换为统一分辨率的图片序列
6. 开发视频合成模块：
   - 使用ffmpeg根据时间轴映射合成视频
   - 添加音频混合

### 第三阶段：后端API与服务层（2天）
1. 设计REST API：
   - POST /api/upload：文件上传
   - POST /api/process：启动处理任务
   - GET /api/task/{task_id}/status：获取任务状态和进度
   - GET /api/task/{task_id}/result：获取处理结果（视频下载）
2. 实现任务状态管理（使用SQLite存储任务记录）
3. 实现异步处理流程（使用FastAPI BackgroundTasks）
4. 添加错误处理和日志记录

### 第四阶段：前端WebUI开发（3天）
1. 创建Vue 3项目基础结构
2. 实现文件上传组件（支持拖拽和选择文件）
3. 实现参数配置表单（相似度阈值、最小展示时长等）
4. 实现任务状态显示组件（实时进度条、阶段提示）
5. 实现结果预览组件（视频播放器、下载链接）
6. 集成API调用，实现完整用户流程
7. 添加响应式设计和美化样式

### 第五阶段：集成测试与优化（2天）
1. 编写后端单元测试（pytest）
2. 测试不同场景：各种PPT格式、字幕文件格式
3. 性能优化：缓存模型加载、并行处理
4. 前端测试和兼容性验证
5. 整体流程端到端测试

### 第六阶段：部署与文档（1天）
1. 编写Dockerfile和docker-compose.yml
2. 创建启动脚本和配置说明
3. 编写用户使用文档
4. 编写API文档（使用FastAPI自动生成）

## 关键算法细节
### 语义对齐算法
1. **输入**：
   - PPT页面文本列表：[page1_text, page2_text, ...]
   - 字幕片段列表：[{"start": seconds, "end": seconds, "text": str}, ...]
2. **处理**：
   - 使用sentence-transformers模型将文本转换为向量
   - 计算相似度矩阵 S[i][j] = cosine_sim(subtitle_emb[i], page_emb[j])
   - 对于每个字幕片段i，找到相似度最高的页面j_max
   - 应用约束生成最终映射：
     - 页面索引单调不减：确保页面切换只向前不向后
     - 相似度阈值：低于阈值的匹配视为无效
     - 最小展示时长：合并连续相同页面，确保每个页面展示至少最小时长
3. **输出**：时间轴映射列表 [{"start": t1, "end": t2, "page_index": p}, ...]

## 依赖管理
### Python依赖（requirements.txt）
```
fastapi>=0.104.0
uvicorn[standard]
python-pptx>=0.6.23
pysrt>=1.1.2
sentence-transformers>=2.2.2
numpy>=1.24.0
scipy>=1.11.0
pdf2image>=1.16.3
pptx2pdf>=0.1.5
ffmpeg-python>=0.2.0
sqlalchemy>=2.0.0
celery>=5.3.0
pillow>=10.0.0
```

### 系统依赖
- FFmpeg（必须）
- LibreOffice（用于PPTX转PDF）
- Poppler（pdf2image依赖）

## 风险评估与应对
1. **PPTX转图片质量**：依赖LibreOffice转换，可能样式有差异。应对：测试多种PPT模板，提供分辨率选项。
2. **语义对齐准确度**：依赖sentence-transformers模型，对中文支持可能有限。应对：可选择多语言模型或微调。
3. **处理时间**：视频生成可能耗时较长。应对：使用异步任务，提供进度反馈。
4. **大文件处理**：内存占用可能过高。应对：流式处理，清理临时文件。

## 交付物
1. 完整的源代码（前后端）
2. Docker容器化部署配置
3. 用户使用文档
4. API文档
5. 测试用例集

## 时间估算
总开发时间：约12人日（包括测试和文档）

---

**下一步**：请确认此计划，确认后我将开始实施。