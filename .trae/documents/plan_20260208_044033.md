# 解决LibreOffice依赖问题

## 问题分析

用户报告了以下错误：
1. `FileNotFoundError: [WinError 2] 系统找不到指定的文件。`
2. `Exception: 未找到LibreOffice，请确保已安装并添加到PATH`

### 根本原因
1. **配置问题**：`config.py`中`LIBREOFFICE_PATH`默认值为`"soffice"`（Linux可执行文件名）
2. **Windows兼容性**：Windows系统需要`soffice.exe`且可能需要完整路径
3. **依赖缺失**：系统可能未安装LibreOffice或未正确配置PATH

### 当前状态
好消息是服务器已经成功启动，之前的所有修复（路由冲突、SRT解析、模型加载）均已生效。现在只是在处理PPTX文件时遇到了外部依赖问题。

## 解决方案

### 方案一：检查并安装LibreOffice（推荐）

#### 步骤1：检查系统是否已安装LibreOffice
```bash
# 检查soffice.exe是否在PATH中
where soffice
where soffice.exe
where libreoffice

# 检查常见安装位置
dir "C:\Program Files\LibreOffice\program\soffice.exe"
dir "C:\Program Files (x86)\LibreOffice\program\soffice.exe"
```

#### 步骤2：安装LibreOffice（如未安装）
1. 下载地址：https://www.libreoffice.org/download/download/
2. 选择Windows版本下载并安装
3. 安装时选择"将LibreOffice添加到系统PATH"

#### 步骤3：验证安装
```bash
soffice --version
```

### 方案二：改进系统配置

#### 步骤1：更新配置文件支持多平台
修改`app/core/config.py`，根据操作系统自动选择默认路径：
```python
# 外部工具路径
import platform
if platform.system() == "Windows":
    LIBREOFFICE_PATH: str = "soffice.exe"  # Windows默认值
else:
    LIBREOFFICE_PATH: str = "soffice"  # Linux/macOS默认值
```

#### 步骤2：添加环境变量支持
允许通过`.env`文件或环境变量覆盖默认路径：
```python
# 在Settings类中添加
LIBREOFFICE_PATH: str = Field(default="soffice.exe" if platform.system() == "Windows" else "soffice", env="LIBREOFFICE_PATH")
```

#### 步骤3：改进错误信息
修改`app/services/ppt_service.py`，提供更清晰的安装指导：
- 在FileNotFoundError异常中提供下载链接
- 提示用户检查PATH配置
- 提供常见问题解决方法

### 方案三：创建备用PPT处理方案（长期优化）

#### 步骤1：添加Python原生PPT处理
使用`python-pptx`库提取幻灯片文本和基本信息（如果只需要文本内容）

#### 步骤2：实现图像提取备选方案
- 使用`comtypes`与Microsoft Office交互（需要安装Office）
- 使用`wand`（ImageMagick）处理PPTX（如果已安装）

## 实施计划

### 第一阶段：立即修复（15分钟）
1. **检查当前LibreOffice状态**
   - 使用`where`命令查找可执行文件
   - 检查常见安装路径

2. **更新配置文件**
   - 修改`config.py`支持Windows默认路径
   - 添加平台检测逻辑

3. **改进错误处理**
   - 在`ppt_service.py`中添加更详细的错误信息
   - 提供安装指导

### 第二阶段：验证测试（10分钟）
1. **测试LibreOffice命令**
   - 运行`soffice --version`验证安装
   - 测试简单的PPTX转换

2. **测试系统集成**
   - 上传测试PPTX文件
   - 验证整个处理流程

### 第三阶段：长期优化（可选）
1. **实现备用方案**
   - 添加`python-pptx`依赖
   - 实现文本提取功能
   - 作为LibreOffice不可用时的备选

## 技术细节

### Windows下LibreOffice常见路径
```
C:\Program Files\LibreOffice\program\soffice.exe
C:\Program Files (x86)\LibreOffice\program\soffice.exe
```

### 配置优先级
1. 环境变量 `LIBREOFFICE_PATH`
2. `.env`文件配置
3. 平台默认值

### 错误处理改进
```python
except FileNotFoundError:
    if platform.system() == "Windows":
        raise Exception(
            "未找到LibreOffice。请执行以下步骤：\n"
            "1. 下载安装：https://www.libreoffice.org/download/download/\n"
            "2. 安装时选择'添加到PATH'\n"
            "3. 或设置LIBREOFFICE_PATH环境变量指向soffice.exe路径\n"
            "常见路径：C:\\Program Files\\LibreOffice\\program\\soffice.exe"
        )
    else:
        raise Exception("未找到LibreOffice，请安装：sudo apt-get install libreoffice")
```

## 风险控制

1. **回退方案**：所有修改都是向后兼容的
2. **配置灵活性**：用户可以通过环境变量覆盖默认设置
3. **逐步验证**：先检查现有安装，再指导安装

## 预期结果

完成修复后，系统将能够：
1. ✅ 自动检测操作系统并设置合适的默认路径
2. ✅ 提供清晰的安装指导
3. ✅ 支持通过环境变量自定义路径
4. ✅ 正确处理PPTX文件转换

---

确认此计划后，我将开始实施修复。